rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user is an Admin or Super User
    // We read the 'role' field from the user's document in the 'users' collection
    function isAdminOrSuperUser() {
      return isSignedIn() && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-user');
    }

    // Helper function to check if user is a Super User
    function isSuperUser() {
      return isSignedIn() && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-user';
    }

    // Helper function to check if the user is accessing their own document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Anyone can read user profiles (needed for showing attendees, etc.)
      allow read: if isSignedIn();

      // Users can only update their own profile fields EXCEPT 'role'
      // Admins/SuperUsers can update anything
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.get('role', 'student'))
                    || isAdminOrSuperUser();
      
      // Only Admins/SuperUsers can delete users
      allow delete: if isAdminOrSuperUser();

      // Creation: Allow users to create their own doc, but ROLE must be 'student'
      allow create: if isOwner(userId)
                    && request.resource.data.role == 'student';
    }

    // --- EVENTS COLLECTION ---
    match /events/{eventId} {
      // Anyone can read events
      allow read: if true;

      // Admins/SuperUsers can create and delete events
      allow create, delete: if isAdminOrSuperUser();
      
      // Update: Admins can update anything
      // Regular signed-in users can ONLY update interestedCount or registered fields
      allow update: if isAdminOrSuperUser() 
                    || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['interestedCount', 'registered']));
    }

    // --- CATEGORIES COLLECTION ---
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;
      
      // Only Admins/SuperUsers can manage categories
      allow write: if isAdminOrSuperUser();
    }

    // --- REGISTRATIONS COLLECTION ---
    match /registrations/{registrationId} {
      // Allow signed-in users to read all registrations (needed for real-time listeners and counts)
      // Individual user data is limited in the document itself (only userId, eventId, status visible)
      allow read: if isSignedIn();

      // Users can create a registration if they are the 'userId' listed in the doc
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Users can update their own registration (e.g., cancel), Admins can update any
      allow update: if isAdminOrSuperUser() || (isSignedIn() && resource.data.userId == request.auth.uid);

      // Users can delete (cancel) their own registration, ONLY SUPER USERS can delete any
      allow delete: if isSuperUser() || (isSignedIn() && resource.data.userId == request.auth.uid);
    }
    // --- STUDENT IDS LOOKUP (For Uniqueness) ---
    match /student_ids/{studentId} {
      // Allow public read so we can check if an ID is taken before registration
      allow read: if true;
      
      // Allow authorized users to claim a student ID (create/update/delete)
      allow write: if isSignedIn();
    }
  }
}
